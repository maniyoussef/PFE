<div class="container mt-4">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Project and Collaborator Management</mat-card-title>
      <mat-card-subtitle
        >Assign collaborators to your projects and manage
        tickets</mat-card-subtitle
      >
    </mat-card-header>

    <mat-card-content>
      <div *ngIf="loading" class="text-center my-4">
        <mat-spinner diameter="40" class="mx-auto"></mat-spinner>
        <p>Loading data...</p>
      </div>

      <div *ngIf="!loading">
        <!-- Projects and Collaborateurs Section -->
        <h2>Your Projects and Collaborateurs</h2>
        <p>
          Assign collaborateurs to your projects. Tickets created for these
          projects will be sent to you for approval.
        </p>

        <div *ngIf="assignedProjects.length === 0" class="alert alert-info">
          You don't have any assigned projects. Please contact an administrator.
        </div>

        <div *ngFor="let project of assignedProjects" class="project-card mb-4">
          <mat-card>
            <mat-card-header>
              <mat-card-title>{{ project.name }}</mat-card-title>
              <mat-card-subtitle
                >Project ID: {{ project.id }}</mat-card-subtitle
              >
            </mat-card-header>
            <mat-card-content>
              <h3 class="mt-3">Assign Collaborateurs</h3>

              <div
                *ngIf="collaborateurs.length === 0"
                class="alert alert-warning"
              >
                No collaborateurs available for assignment.
              </div>

              <table
                mat-table
                [dataSource]="collaborateurs"
                class="w-100 mb-3"
                *ngIf="collaborateurs.length > 0"
              >
                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Name</th>
                  <td mat-cell *matCellDef="let collaborateur">
                    {{ collaborateur.name }} {{ collaborateur.lastName }}
                  </td>
                </ng-container>

                <!-- Email Column -->
                <ng-container matColumnDef="email">
                  <th mat-header-cell *matHeaderCellDef>Email</th>
                  <td mat-cell *matCellDef="let collaborateur">
                    {{ collaborateur.email }}
                  </td>
                </ng-container>

                <!-- Select Column -->
                <ng-container matColumnDef="select">
                  <th mat-header-cell *matHeaderCellDef>Select</th>
                  <td mat-cell *matCellDef="let collaborateur">
                    <mat-checkbox
                      [checked]="
                        isCollaborateurSelected(project.id, collaborateur.id)
                      "
                      (change)="
                        toggleCollaborateur(project.id, collaborateur.id)
                      "
                    >
                    </mat-checkbox>
                  </td>
                </ng-container>

                <tr
                  mat-header-row
                  *matHeaderRowDef="collaborateursColumns"
                ></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: collaborateursColumns"
                ></tr>
              </table>

              <button
                mat-raised-button
                color="primary"
                (click)="saveCollaborateursAssignments(project.id)"
                [disabled]="assigningCollaborateurs"
              >
                <mat-icon>save</mat-icon> Save Assignments
                <mat-spinner
                  *ngIf="assigningCollaborateurs"
                  diameter="20"
                  class="ml-2"
                ></mat-spinner>
              </button>

              <mat-divider class="my-4"></mat-divider>

              <h3>Currently Assigned Collaborateurs</h3>
              <div
                *ngIf="getProjectCollaborateurs(project.id).length === 0"
                class="alert alert-info"
              >
                No collaborateurs assigned to this project yet.
              </div>

              <mat-list *ngIf="getProjectCollaborateurs(project.id).length > 0">
                <mat-list-item
                  *ngFor="
                    let collaborateur of getProjectCollaborateurs(project.id)
                  "
                >
                  <div class="d-flex align-items-center w-100">
                    <mat-icon mat-list-icon>person</mat-icon>
                    <div class="ms-3">
                      <div class="fw-bold">
                        {{ collaborateur.name }} {{ collaborateur.lastName }}
                      </div>
                      <div class="text-muted">{{ collaborateur.email }}</div>
                    </div>
                  </div>
                </mat-list-item>
              </mat-list>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Pending Tickets Section -->
        <h2 class="mt-5">Pending Tickets</h2>
        <p>
          Review, accept or reject tickets, and assign them to collaborateurs.
        </p>

        <div *ngIf="pendingTickets.length === 0" class="alert alert-info">
          No pending tickets at the moment.
        </div>

        <div *ngIf="pendingTickets.length > 0" class="tickets-container">
          <div *ngFor="let ticket of pendingTickets" class="ticket-card mb-3">
            <mat-card>
              <mat-card-header>
                <mat-card-title>{{ ticket.title }}</mat-card-title>
                <mat-card-subtitle>
                  Project: {{ ticket.project?.name || "N/A" }} | Category:
                  {{ ticket.problemCategory?.name || "N/A" }}
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <p><strong>Description:</strong> {{ ticket.description }}</p>
                <p><strong>Priority:</strong> {{ ticket.priority }}</p>
                <p><strong>Status:</strong> {{ ticket.status }}</p>

                <div *ngIf="ticket.status === 'Accepted'">
                  <h4>Assign to Collaborateur</h4>
                  <div
                    *ngIf="
                      ticket.project &&
                      getProjectCollaborateurs(ticket.project.id).length === 0
                    "
                    class="alert alert-warning"
                  >
                    No collaborateurs assigned to this project. Please assign
                    collaborateurs first.
                  </div>

                  <mat-form-field
                    *ngIf="
                      ticket.project &&
                      getProjectCollaborateurs(ticket.project.id).length > 0
                    "
                    class="w-100"
                  >
                    <mat-label>Select Collaborateur</mat-label>
                    <mat-select #collaborateurSelect>
                      <mat-option
                        *ngFor="
                          let collab of getProjectCollaborateurs(
                            ticket.project.id
                          )
                        "
                        [value]="collab.id"
                      >
                        {{ collab.name }} {{ collab.lastName }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <button
                    mat-raised-button
                    color="primary"
                    *ngIf="
                      ticket.project &&
                      getProjectCollaborateurs(ticket.project.id).length > 0
                    "
                    [disabled]="processingTicket"
                    (click)="assignTicket(ticket, collaborateurSelect.value)"
                  >
                    <mat-icon>assignment_ind</mat-icon> Assign
                  </button>
                </div>
              </mat-card-content>
              <mat-card-actions
                *ngIf="
                  ticket.status === 'Created' || ticket.status === 'Pending'
                "
              >
                <button
                  mat-button
                  color="primary"
                  (click)="acceptTicket(ticket)"
                  [disabled]="processingTicket"
                >
                  <mat-icon>check</mat-icon> Accept
                </button>
                <button
                  mat-button
                  color="warn"
                  (click)="rejectTicket(ticket)"
                  [disabled]="processingTicket"
                >
                  <mat-icon>close</mat-icon> Reject
                </button>
                <mat-spinner
                  *ngIf="processingTicket"
                  diameter="20"
                  class="ml-2"
                ></mat-spinner>
              </mat-card-actions>
            </mat-card>
          </div>
        </div>
      </div>
    </mat-card-content>

    <mat-card-actions>
      <a mat-button routerLink="/chef-projet" color="primary">
        <mat-icon>arrow_back</mat-icon> Back to Dashboard
      </a>
    </mat-card-actions>
  </mat-card>
</div>
